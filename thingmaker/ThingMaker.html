<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Thing Maker</title>
<meta name="author" content="Derrick Oswald" />
<!-- Date: 2013-03-27 -->
<script type="text/javascript" src="./bencoder.js"></script>
<script type="text/javascript" src="./sha1.js"></script>
<script type="text/javascript" src="./ThingMaker.js"></script>
<link href="./css/bootstrap/bootstrap.css" rel="stylesheet">
<link href="./css/thingtracker.css" rel="stylesheet" media="screen" type="text/css">
<link href="./css/thingmaker.css" rel="stylesheet" media="screen" type="text/css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="./css/bootstrap/bootstrap-responsive.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span2"></div>
            <div class="span8">
                <h1>Thing Maker</h1>
                <p>
                    <strong>Create a distributed <em>Thing</em> using the BitTorrent network.
                    </strong>
                </p>
                <div class="row-fluid">
                <div class="span12">
                The idea behind the Thing Maker is to use <a href="https://en.wikipedia.org/wiki/Bittorrent">BitTorrent</a>
                to distribute <a href="http://thingtracker.net/">Thing Tracker things</a>.
                This page helps with steps 1-4 of the process shown below:
                </div>
                </div>
                <img src="assets/Thing%20Maker.svg">
                <div class="step">
                    <h2>STEP 1</h2>
                    Choose a torrent file (created by a BitTorrent client such as the free
                    <a href="http://www.bittorrent.com/bittorrent-plus/index/frmnvh">BitTorrent</a> or
                    <a href="http://www.utorrent.com/utorrent-plus/index/frmrvh">&micro;Torrent</a>
                    which both come from BitTorrent Inc.)
                    that will be used as a basis for the <em>Thing</em> you create.
                    This torrent was created in Step 0 by selecting the files in your <em>Thing</em>, and other
                    data, such as a comment, that are required by the BitTorrent client you are using.
                    <div id="choose_torrent_basis_form">
                        Choose a base torrent file: <input id="files" type="file" name="file" />
                    </div>
                    <div id="byte_content"></div>
                </div>
                <div class="step">
                    <h2>STEP 2</h2>
                    Fill in this form with the metadata for your thing and press the <em>Make Thing</em> button. Tags are comma separated.
                    <form id="thing_form" action="javascript:submit_form ();">
                        <ul>
                        <li><label class="thing_form_label" form="thing_form" for="title">Title</label><input id="title" form="thing_form" type="text" name="title"></li>
                        <li><label class="thing_form_label" form="thing_form" for="URL">URL</label><input id="URL" form="thing_form" type="text" name="URL"></li>
                        <li><label class="thing_form_label" form="thing_form" for="author">Author</label><input id="author" form="thing_form" type="text" name="author"></li>
                        <li><label class="thing_form_label" form="thing_form" for="license">License</label><input id="license" form="thing_form" type="text" name="license"></li>
                        <li><label class="thing_form_label" form="thing_form" for="tags">Tags</label><input id="tags" form="thing_form" type="text" name="tags"></li>
                        <li><label class="thing_form_label" form="thing_form" for="thumbnailURL">Thumbnail URL</label><input id="thumbnailURL" form="thing_form" type="text" name="thumbnailURL"></li>
                        <li><label class="thing_form_label" form="thing_form" for="description">Description</label><input id="description" form="thing_form" type="text" name="description"></li>
                        <li><input class="thing_form_button" form="thing_form" type="submit" value="Make Thing" name="make_thing" disabled="disabled"></li>
                        </ul>
                    </form>
                </div>
                <div class="step">
                    <h2>STEP 3</h2>
                    Download the torrent file by clicking on the link below, save it, and together
                    with the files that you specified in the base torrent file in Step 0,
                    seed your thing in your BitTorrent client.
                    <div id="bencode_content"></div>
                    <div id="torrent_content"></div>
                </div>
                <div class="step">
                    <h2>STEP 4</h2>
                    Publish your <em>Thing</em> by proudly displaying this magnet link.
                    <div id="magnet_content"></div>
                </div>
            </div>
            <div class="span2"></div>
        </div>
    </div>
    <script>

        // torrent to use as a base
        var TorrentFile = null;
        var Torrent = null;

        // show the contents of the Thing object in the content area
        function showcontent (torrent, element)
        {
            // show the torrent contents
            var pre = document.createElement ("pre");
            var code = document.createElement ("code");
            pre.appendChild (code);
            var text = document.createTextNode (torrent.toString ());
            code.appendChild (text);
            var content = document.getElementById (element);
            var child = content.firstChild;
            while (null != child)
            {
                content.removeChild (child);
                child = content.firstChild;
            }
            content.appendChild (pre);
        }

        // copy the Thing properties, if found, to the input fields of the form
        function fillform (torrent)
        {
            var thing = torrent["info"]["thing"];
            if (null != thing)
            {
                var form = document.getElementById ('thing_form');
                if (null != form)
                {
                    for (i = 0; i < form.elements.length; i++)
                    {
                        var child = form.elements[i];
                        var id = child.getAttribute ("id");
                        if (null != id)
                        {
                            var value = thing[id];
                            // based on the type, assign the value
                            if (null != value)
                                child.value = value;
                        }
                    }
                }
            }
        }

        // enable the Make Thing button
        function enablebutton ()
        {
            var children = document.getElementsByName ("make_thing");
            for (i = 0; i < children.length; i++)
            {
                var child = children[i];
                child.removeAttribute ("disabled");
            }
        }

        // callback for reading the torrent file
        function cb (filename, torrent)
        {
            TorrentFileName = filename;
		    Torrent = torrent;
		    enablebutton ();
            showcontent (torrent, "byte_content");
            fillform (torrent);
        }

        // make a title for the thing
        function maketitle ()
        {
            var title = Torrent["info"]["thing"]["title"];
            if (null == title)
            {
                var thing_file = TorrentFileName || "Thing"; // default name is the file name
                var n = thing_file.lastIndexOf (".");
                if (-1 == n)
                    title = thing_file;
                else
                    title = thing_file.substring (0, n);
            }
            title = title.replace (/\&/g, "and");
            title = title.replace (/ /g, "%20");

            return (title);
        }

        // show the contents of the encoded Thing as a link in the content area
        function showlink (torrent)
        {
            // show the torrent contents
            var a = document.createElement ("a");
            a.setAttribute ("href", "data:application/octet-stream;base64," + btoa (torrent));
            a.setAttribute ("download", maketitle () + ".torrent");
            var text = document.createTextNode ("Torrent File");
            a.appendChild (text);
            var content = document.getElementById ('bencode_content');
            var child = content.firstChild;
            while (null != child)
            {
                content.removeChild (child);
                child = content.firstChild;
            }
            content.appendChild (a);
        }

        // show the magnet url as a link in the content area
        function showmagnet ()
        {
            // generate the 160 bit (40 hex characters) info primary key magnet URL
            var title = maketitle ();
            var info = Torrent["info"];
            var primary_key = sha1 (encode (info));
            var magnet = "magnet:?xt=urn:btih:" + primary_key + "&dn=" + title;

            // show the magnet link URI
            var a = document.createElement ("a");
            a.setAttribute ("href", magnet);
            a.setAttribute ("title", "Download this torrent using magnet");
            var img = document.createElement ("img");
            a.appendChild (img);
            img.setAttribute ("id", "magnet_icon");
            img.setAttribute ("src", "https://upload.wikimedia.org/wikipedia/commons/7/7c/Magnet_icon.svg");
            img.setAttribute ("height", "48");
            img.setAttribute ("width", "48");
            var text = document.createTextNode ("Magnet Link");
            a.appendChild (text);
            var content = document.getElementById ('magnet_content');
            var child = content.firstChild;
            while (null != child)
            {
                content.removeChild (child);
                child = content.firstChild;
            }
            content.appendChild (a);

            // show the HTML code
            var div = document.createElement ("div");
            text = document.createTextNode (content.innerHTML);
            div.appendChild (text);
            content.appendChild (div);
        }

        // callback for writing (and then reading back) the torrent file
        function callback (filename, torrent)
        {
            showcontent (torrent, "torrent_content");
            showmagnet (torrent);
        }

        // called on form submit
        function submit_form ()
        {
            if (null != Torrent)
            {
                Torrent["info"]["thing"] = {};
                var thing = Torrent["info"]["thing"];
                var form = document.getElementById ('thing_form');
                if (null != form)
                {
                    for (i = 0; i < form.elements.length; i++)
                    {
                        var child = form.elements[i];
                        var id = child.getAttribute ("id");
                        if (null != id)
                        {
                            var value = child.value;
                            if ((null != value) && ("" != value))
                            {
                                thing[id] = value;
                                // kludge here to handle the list of tags
                                if ("tags" == id)
                                    thing[id] = value.split (',');
                            }
                        }
                    }
                }

                var output = encode (Torrent);
                showlink (output);
                ReadStringAsync (output, callback);
            }
        }

        document.querySelector ('#files').addEventListener ('change', function (evt)
        {
            if (evt.target.tagName.toLowerCase () == 'input')
            {
                var files;

                files = document.getElementById ('files').files;
                if (0 != files.length)
                    ReadTorrentAsync (files[0], cb);
                else
                    alert ('Please select a file.');
            }
        }, false);
    </script>
</body>
</html>

